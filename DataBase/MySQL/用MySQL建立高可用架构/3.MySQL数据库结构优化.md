#MySQL数据库结构优化

在设计数据库的时候不仅要考虑业务需要，也要考虑将来编写什么样的查询语句才可以得到这样的效果。良好的数据库逻辑设计和物理设计是数据库获得高性能的基础。

##1.数据库结构优化介绍

数据库结构优化的目的

>1.减少数据冗余（而不是完全消除冗余）

>2.尽量避免数据维护中出现的更新、插入和删除异常（表中的某个实体依靠另外一个实体而存在的情况）

>3.节约数据库的存储空间

>4.提高查询效率

##2.数据库结构设计

数据库设计步骤

>1.需求分析：了解产品设计的存储需求、数据处理需求、数据的生命周期和数据的安全和完整性需求

>2.逻辑设计：不关心数据库的选择或者存储引擎的选择，只设计数据的逻辑存储结构、数据实体之间的逻辑关系，解决数据冗余和数据维护异常（数据库范式）

>3.物理设计：根据所使用的数据库特点进行表结构设计（关系型数据库或者非关系型数据库、不同的存储引擎）

>4.维护优化：根据实际情况对索引、存储结构进行优化，数据字典的维护

数据库设计范式

不一定完全按照范式来设计数据库，有时为了提高某些数据的查询效率，可以做出适当的反范式设计

>1.第一范式：数据库表中的所有字段都只有单一属性，而且单一属性的列是由基本的数据类型所构成的，设计出来的表都是简单的二位表

>2.第二范式：表中有且只有一个主键

>3.第三范式：每个非主属性既不部分依赖于也不传递依赖与业务主键。

##3.需求分析及逻辑设计

举例：设计一个电子商务网站的数据库结构

>1.本网站只销售图书类的商品

>2.需要具有以下功能：用户登录，用户管理，商品展示，商品管理，供应商管理，在线销售

用户登录及用户管理功能--

用户必须注册并登录系统才能进行网上交易，用户必须有一个唯一的标识码来区别（可以使用id作为用户信息的业务主键）

保障安全性，同一时间一个用户只能在一个地方登录，系统必须记录用户的登录状态

用户在登录时必须提供一些用户信息：用户名、密码、手机号、姓名、出生日期、注册日期（系统维护）、在线状态（系统维护）、、、

商品展示及商品管理功能

商品信息：商品名称，出版社名称（可能一本书有多个出版社联合出版），图书价格，图书描述，作者（可能一本书有多个作者）

分类信息：分类名称、分类描述

商品分类（对应关系表）：商品名称、分类名称

供应商管理功能

供应商信息：出版社名称、地址、电话、联系人、银行帐号

在线销售模块（核心）

在线销售：订单编号，下单用户名，下单日期，订单金额，订单商品分类，订单商品名，订单商品单价，订单商品数量，支付金额，物流单号

改良：

订单表：订单编号，下单用户名，下单日期，支付金额，物流单号（订单的价格可以通过计算得出）

订单商品的关联表：订单编号，订单商品分类，订单商品名，商品数量

（以上设计虽然符合范式，但是在查询时关联的表过多，造成查询效率低下；此外在商品表中记录商品价格，导致商品的单价无法变化，查询历史订单的时候用户希望看到当时购买的价格而不是现在的售价）

关于主键

>1.主键应该尽可能的小

>2.主键应该是顺序增长的（增加数据的插入效率）

>3.主键和业务主键可以不同
##4.需求分析及逻辑设计--反范式化设计

反范式化为了性能和读取效率的考虑而适当违反数据库的设计范式，允许存在少量数据冗余，用空间换取时间。

商品信息的反范式化改造

商品信息：商品名称，分类名称，出版社名称，图书价格，图书描述，作者

分类信息：分类名称，分类描述（避免插入异常）

（取消了商品分类关系表）

订单表的反范式化改造

订单表：订单编号，下单用户名，手机号，下单日期，支付金额，物流单号，订单金额

订单商品关联表：订单编号，订单商品分类，订单商品名称，商品数量，商品单价

（就可以快速查询用户的手机号和姓名，可以快速查询订单的金额，同时避免物品单价改变影响订单的金额）

##5.范式化设计和反范式化设计的优缺点

范式化设计的优点：

>1.可以尽量的减少数据冗余

>2.范式化的更新操作比反范式化更快

>3.范式化的表通常比反范式化更小

范式化设计的缺点：

>1.对于查询需要对多个表进行关联（读操作的效率低于写操作的效率）

>2.更难进行索引优化

反范式化设计的优点：

>1.可以减少表的关联

>2.可以更好的进行索引优化

反范式化设计的缺点：

>1.存在数据冗余以及数据维护异常

>2.对数据的修改需要更多的成本（CPU时间，磁盘IO）

##6.物理设计介绍

根据所选择的关系型数据库的特点对逻辑模型进行存储结构设计

物理设计设计的内容：

>1.定义数据库、表和字段的命名规范

在团队中的字典：可读性原则，表意性原则，长名原则

>2.选择合适的存储引擎

>3.为表中的字段选择合适的数据类型

>4.建立数据库结构

##7.物理设计-数据类型的选择

当一个列可以选择多种数据类型时，应该优先考虑数字类型，其次是日期或者二进制类型，最后考虑字符类型。对于相同级别的数据类型，应该优先选择占用空间小的数据类型。因为在在排序时字符型要参考字典规则，而数据、时间或者二进制类型可以直接比较大小。此外数据库每页的大小恒定，使用占用空间比较小的数据会减少加载的页，减少磁盘IO。

整数类型选择：tinyint smallint mediumint int bigint 直接使用Int(2)对于限制宽度没有任何意义，如果要使用两位的整数，就要使用tinyint之类

实数类型选择：Float double decimal（精确类型，财务相关）

字符串类型：VARCHAR（最常用） CHAR 

>VARCHAR用于存储变长字符串，只占用必要的存储空间。VARCHAR定义的宽度是字符而不是字节（一个字符可以占有多个字节）。列的最大长度小于255则只占用一个额外字节用于记录字符串长度，列的最大长度大于255则要占用两个额外字节用于记录字符串长度。

>CHAR类型的长度是定长的，字符串存储在CHAR类型的列中会删除末尾的空格，CHAR类型的长度只有255个

如何选择VARCHAR或者CHAR

>1.VARCHAR适用于字符串列的最大长度比平均长度大很多的字段。

>2.VARCHAR适合字符串很少被更新的字段（可变存储会引起碎片）

>3.VARCHAR适合使用了很多字符集存储字符串的字段

>4.CHAR类型式混合存储所长度近似的值（md5 身份证）

>5.CHAR类型适合存储短字符串

>6.CHAR类型适合存储经常更新的字符串列

如何确定VARCHAR类的宽度：

使用最小的符合需求的长度，宽度增加会增加内存开销

##8.物理设计-如何存储日期类型

1.DATATIME类型 

YYYY-MM-DD HH:MM:SS[.fraction]格式存储日期时间

datatime=YYYY-MM-DD HH:MM:SS
datatime(6)=YYYY-MM-DD HH:MM:SS.fraction 6位微秒

DATATIME类型与时区无关，占用8个字节的存储空间，1000-01-01 00:00:00 -- 9999-12-31 23:59:59

2.TIMESTAMP类型 时间戳

存储了由格林尼治时间1970-01-01到当前时间的秒数（Unix系统计算方法），TIMESTAMP类型显示依赖于所指定的时区，占用4个字节，时间跨度比DATATIME小 1970-01-01 -- 2038-01-19

在行的数据修改时可以自动修改TIMESTAMP的值

3.data类型和time类型

某些需求中只需要存储日期而不要存储时间（生日） 1000-01-01 -- 9999-12-31

>1.把日期部分存储为字符串（至少要8个字）

>2.使用int类型来存储（4个字节）

>3.使用datatime类型来存储（8个字节）

data类型的优点：

1.占用的字节数比使用字符串、datatime、int存储要少，使用data类型只需要3个字节

2.使用Data类型还可以利用日期时间函数进行日期之间的计算

time类型用于存储时间数据，格式为HH:MM:SS

存储日期时间数据的注意事项

>1.不要使用字符串类型来存储日期时间数据，因为日期时间类型通常比字符串占用的存储空间小，而且在进行查找过滤时可以利用日期来进行对比，此外，日期时间类型还有丰富的处理函数，可以方便的对日期时间类型进行日期计算。

>2.使用Int存储日期不如TimeStamp类型


